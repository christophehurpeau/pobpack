{"version":3,"file":"index-node12.mjs","sources":["../src/createOptions.ts","../src/createAppWebpackConfig.ts","../src/FriendlyErrorsWebpackPlugin.ts","../src/createPobpackCompiler.ts","../src/webpack/createModuleConfig.ts","../src/webpack/createPluginsConfig.ts","../src/webpack/createResolveConfig.ts"],"sourcesContent":["/* eslint-disable complexity */\nimport type { Options } from 'pobpack-types';\n\nexport default function createOptions(options: Partial<Options>): Options {\n  return {\n    aliases: options.aliases || {},\n    babel: options.babel || {},\n    defines: options.defines || {},\n    entries: options.entries || ['index'],\n    serviceWorkerEntry:\n      options.serviceWorkerEntry === undefined\n        ? 'service-worker'\n        : options.serviceWorkerEntry,\n    env: options.env || process.env.NODE_ENV,\n    hmr: options.hmr,\n    allowlistExternalExtensions: options.allowlistExternalExtensions || [],\n    includeModules: options.includeModules || [],\n    includePaths: options.includePaths || [],\n    jsLoaders: options.jsLoaders,\n    moduleRules: options.moduleRules,\n    paths: { src: 'src', build: 'build', ...options.paths },\n    optimization: options.optimization,\n    plugins: options.plugins || [],\n    prependPlugins: options.prependPlugins || [],\n    resolveLoaderModules: options.resolveLoaderModules,\n    typescript: options.typescript || false,\n    webpackPrefixPackageFields: options.webpackPrefixPackageFields || [],\n  };\n}\n","import { existsSync } from 'fs';\nimport { resolve } from 'path';\nimport type { Options, FilledWebpackConfiguration } from 'pobpack-types';\nimport createOptions from './createOptions';\n\nexport type CreateWebpackConfig = (\n  options: Options,\n) => FilledWebpackConfiguration;\n\nexport type CreateWebpackConfigPartialOptions = (\n  options: Partial<Options>,\n) => FilledWebpackConfiguration;\n\nexport type AppWebpackConfigCreator = (\n  createWebpackConfig: CreateWebpackConfigPartialOptions,\n  options: Partial<Options>,\n) => FilledWebpackConfiguration;\n\nexport default function createAppWebpackConfig(\n  createWebpackConfig: CreateWebpackConfig,\n): CreateWebpackConfigPartialOptions {\n  const wrapCreateWebpackConfig: CreateWebpackConfigPartialOptions = (\n    options,\n  ) => createWebpackConfig(createOptions(options));\n\n  return (options: Partial<Options>): FilledWebpackConfiguration => {\n    const appWebpackConfigPath = resolve('createAppWebpackConfig.js');\n    if (existsSync(appWebpackConfigPath)) {\n      console.info('Using app createAppWebpackConfig.js');\n      // eslint-disable-next-line import/no-dynamic-require, @typescript-eslint/no-var-requires, @typescript-eslint/no-unsafe-assignment\n      const appWebpackConfigCreator: AppWebpackConfigCreator = require(appWebpackConfigPath);\n      if (typeof appWebpackConfigCreator !== 'function') {\n        console.error(\n          'app createAppWebpackConfig.js should export a function\\n' +\n            'module.exports = function (config, options) { ... }',\n        );\n      }\n\n      options = createOptions(options);\n      const config = appWebpackConfigCreator(wrapCreateWebpackConfig, options);\n\n      if (typeof config !== 'object') {\n        console.error(\n          'app createAppWebpackConfig.js should return the config\\n' +\n            'function (config, options) { return config(options); }',\n        );\n      }\n\n      return config;\n    } else {\n      return wrapCreateWebpackConfig(options);\n    }\n  };\n}\n","/* eslint-disable no-console */\n\nimport { addConfig, levels } from 'nightingale';\nimport ConsoleHandler from 'nightingale-console';\nimport Logger from 'nightingale-logger';\n// import formatWebpackMessages from 'react-dev-utils/formatWebpackMessages';\nimport type { Compiler } from 'webpack';\n\nexport interface Options {\n  bundleName: string;\n  successMessage?: string;\n}\n\naddConfig({ key: 'pobpack-utils', handler: new ConsoleHandler(levels.INFO) });\nconst logger = new Logger('pobpack-utils', 'pobpack');\n\nconst pluginName = 'pobpack/FriendlyErrorsWebpackPlugin';\n\nexport default class FriendlyErrorsWebpackPlugin {\n  logger: Logger;\n\n  bundleName: string;\n\n  successMessage?: string;\n\n  constructor(options: Options) {\n    this.bundleName = options.bundleName;\n    this.successMessage = options.successMessage;\n    this.logger = logger.context({ bundleName: options.bundleName });\n  }\n\n  apply(compiler: Compiler): void {\n    // webpack is recompiling\n    compiler.hooks.invalid.tap(pluginName, () => {\n      console.log();\n      this.logger.info('Compiling...');\n    });\n\n    // compilation done\n    compiler.hooks.done.tap(pluginName, (stats) => {\n      console.log();\n\n      if (stats.hasErrors()) {\n        this.logger.critical('Failed to compile.');\n        console.log();\n\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-call\n        stats.toJson({}).errors.map((error: any) =>\n          // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n          console.log(error?.message ? error.message : error),\n        );\n\n        return;\n      }\n\n      if (process.send) process.send('ready');\n\n      if (stats.hasWarnings()) {\n        this.logger.critical('Compiled with warnings.');\n        console.log();\n\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-call\n        stats.toJson({}).warnings.map((warning: any) =>\n          // eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\n          console.log(warning?.message ? warning.message : warning),\n        );\n        return;\n      }\n\n      this.logger.success('Compiled successfully!');\n\n      if (this.successMessage) {\n        console.log(this.successMessage);\n      }\n    });\n  }\n}\n","import { execSync } from 'child_process';\nimport { promisify } from 'util';\nimport colorette from 'colorette';\nimport type {\n  PobpackCompiler,\n  CreateCompilerOptions,\n  FilledWebpackConfiguration,\n} from 'pobpack-types';\nimport ProgressBar from 'progress';\nimport type { Stats } from 'webpack';\nimport webpack, { ProgressPlugin } from 'webpack';\nimport FriendlyErrorsWebpackPlugin from './FriendlyErrorsWebpackPlugin';\n\nconst buildThrowOnError = (stats?: Stats): Stats | undefined => {\n  if (!stats) return stats;\n  if (!stats.hasErrors()) {\n    return stats;\n  }\n\n  throw new Error(stats.toString({}));\n};\n\nexport default function createPobpackCompiler(\n  bundleName: string,\n  webpackConfig: FilledWebpackConfiguration,\n  { progressBar = true, successMessage }: CreateCompilerOptions = {},\n): PobpackCompiler {\n  const compiler = webpack(webpackConfig);\n\n  if (progressBar && process.stdout.isTTY) {\n    let bar: ProgressBar | undefined;\n    const progressPlugin = new ProgressPlugin((percentage, msg) => {\n      if (!bar || percentage === 0) {\n        bar = new ProgressBar(\n          `${colorette.bold(\n            colorette.yellow(`Building ${bundleName} bundle...`),\n          )} ${colorette.bold(':percent')} [:bar] → :msg`,\n          {\n            incomplete: ' ',\n            complete: '▇',\n            total: 50,\n            clear: true,\n            stream: process.stdout,\n          },\n        );\n        // } else if (percentage === 1) {\n        //   // bar.clear();\n        //   bar = null;\n      } else {\n        bar.update(percentage, {\n          msg: msg.length > 20 ? `${msg.slice(0, 20)}...` : msg,\n        });\n        if (percentage === 1) {\n          bar = undefined;\n        }\n      }\n    });\n    progressPlugin.apply(compiler);\n  }\n\n  // human-readable error messages\n  new FriendlyErrorsWebpackPlugin({ bundleName, successMessage }).apply(\n    compiler,\n  );\n\n  const promisifyRun: () => Promise<Stats | undefined> = promisify(\n    compiler.run.bind(compiler),\n  );\n  const promisifyClose: () => Promise<void> = promisify(\n    compiler.close.bind(compiler),\n  );\n\n  return {\n    compiler,\n    webpackConfig,\n    clean: (): void => {\n      if (webpackConfig.output?.path) {\n        execSync(`rm -Rf ${webpackConfig.output.path}`);\n      }\n    },\n    close: promisifyClose,\n    run: (): Promise<Stats | undefined> =>\n      promisifyRun().then(buildThrowOnError),\n    watch: (callback: (stats?: Stats) => unknown) =>\n      compiler.watch({}, (err?: Error, stats?: Stats): void => {\n        if (err || !stats) return;\n        if (stats.hasErrors()) return;\n        buildThrowOnError(stats);\n        callback(stats);\n      }),\n  };\n}\n","import { realpathSync } from 'fs';\nimport { resolve, dirname } from 'path';\nimport findUp from 'find-up';\nimport type { Options } from 'pobpack-types';\nimport resolveFrom from 'resolve-from';\nimport type { Configuration } from 'webpack';\n// with node 10.12\n// import { createRequireFromPath } from 'module';\n// const requireFromPwd = createRequireFromPath(process.cwd());\n\nconst ExcludesFalsy = (Boolean as unknown) as <T>(\n  x: T | boolean | null | undefined,\n) => x is T;\n\nexport default function createModuleConfig(\n  options: Options,\n): NonNullable<Configuration['module']> {\n  return {\n    strictExportPresence: true,\n\n    rules: [\n      // Disable require.ensure as it's not a standard language feature.\n      { parser: { requireEnsure: false } },\n\n      // tsx? / jsx?\n      {\n        test: options.typescript ? /\\.(mjs|[jt]sx?)$/ : /\\.(mjs|jsx?)$/,\n        include: [\n          resolve(options.paths.src as string),\n          ...options.includeModules\n            .map((includeModule) => {\n              const packageJson = findUp.sync('package.json', {\n                cwd: dirname(\n                  // requireFromPwd.resolve(includeModule)\n                  realpathSync(resolveFrom(process.cwd(), includeModule)),\n                ),\n              });\n\n              if (!packageJson) return;\n              return packageJson.slice(0, -'package.json'.length);\n            })\n            .filter(ExcludesFalsy),\n          ...options.includePaths,\n        ],\n        use: [\n          {\n            loader: require.resolve('babel-loader'),\n            options: {\n              babelrc: false,\n              cacheDirectory: true,\n              ...options.babel,\n            },\n          },\n          ...(options.jsLoaders || []),\n        ],\n      },\n\n      // other rules\n      ...(options.moduleRules || []),\n    ],\n  };\n}\n","import CaseSensitivePathsPlugin from 'case-sensitive-paths-webpack-plugin';\nimport type { Options } from 'pobpack-types';\nimport type { Configuration } from 'webpack';\nimport webpack from 'webpack';\n\nconst ExcludesFalsy = (Boolean as unknown) as <T>(\n  x: T | boolean | null | undefined,\n) => x is T;\n\nexport default function createPluginsConfig(\n  options: Options,\n): NonNullable<Configuration['plugins']> {\n  const plugins: unknown[] = [\n    ...(options.prependPlugins || []),\n\n    // enforces the entire path of all required modules match the exact case\n    // of the actual path on disk. Using this plugin helps alleviate cases\n    // for developers working on case insensitive systems like OSX.\n    options.env !== 'production' && new CaseSensitivePathsPlugin(),\n\n    new webpack.DefinePlugin({\n      'process.env.NODE_ENV': JSON.stringify(options.env),\n      ...options.defines,\n    }),\n\n    options.hmr && new webpack.HotModuleReplacementPlugin(),\n\n    /* replace object-assign ponyfill to use native implementation */\n\n    // Array.isArray\n    new webpack.NormalModuleReplacementPlugin(\n      /.*\\/node_modules\\/isarray\\/index.js$/,\n      require.resolve('../replacements/Array.isArray.js'),\n    ),\n\n    // Object.assign\n    new webpack.NormalModuleReplacementPlugin(\n      /.*\\/node_modules\\/(object-assign|extend-shallow)\\/index.js$/,\n      require.resolve('../replacements/Object.assign.js'),\n    ),\n\n    // Object.setPrototypeOf\n    new webpack.NormalModuleReplacementPlugin(\n      /.*\\/node_modules\\/setprototypeof\\/index.js$/,\n      require.resolve('../replacements/Object.setPrototypeOf.js'),\n    ),\n\n    // Promise\n    new webpack.NormalModuleReplacementPlugin(\n      /.*\\/node_modules\\/any-promise\\/index.js$/,\n      require.resolve('../replacements/Promise.js'),\n    ),\n\n    // String.prototype.repeat\n    new webpack.NormalModuleReplacementPlugin(\n      /.*\\/node_modules\\/repeat-string\\/index.js$/,\n      require.resolve('../replacements/String.prototype.repeat.js'),\n    ),\n\n    // Symbol.observable\n    // https://github.com/tc39/proposal-observable\n    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol/observable\n    // new webpack.NormalModuleReplacementPlugin(\n    //   /.*\\/node_modules\\/symbol-observable\\/es\\/ponyfill.js$/,\n    //   require.resolve('../replacements/Symbol.observable.js'),\n    // ),\n\n    ...options.plugins,\n  ];\n\n  return plugins.filter(ExcludesFalsy) as NonNullable<Configuration['plugins']>;\n}\n","/* eslint-disable complexity */\nimport { resolve } from 'path';\nimport type { Options } from 'pobpack-types';\nimport type { Configuration } from 'webpack';\n\nconst ExcludesFalse = (Boolean as any) as <T>(x: T | false) => x is T;\n\nexport default function createResolveConfig(\n  modulePrefixPackageFields: string[],\n  options: Options,\n): NonNullable<Configuration['resolve']> {\n  return {\n    // https://github.com/DefinitelyTyped/DefinitelyTyped/pull/25209\n    // cacheWithContext: false,\n\n    modules: ['node_modules', resolve('src')],\n    extensions: ([\n      options.typescript && '.ts',\n      options.typescript && '.tsx',\n      '.mjs',\n      '.js',\n      '.jsx',\n    ] as (string | false)[]).filter(ExcludesFalse),\n\n    mainFields: [\n      ...([] as (string | false)[]).concat(\n        ...modulePrefixPackageFields.map((prefix: string): (\n          | string\n          | false\n        )[] => [\n          options.env !== 'production' && `module:${prefix}-dev`,\n          `module:${prefix}`,\n          // old `webpack:` syntax\n          options.env !== 'production' && `webpack:${prefix}-dev`,\n          `webpack:${prefix}`,\n        ]),\n      ),\n\n      options.env !== 'production' && 'module-dev',\n      'module',\n      // old webpack: syntax\n      options.env !== 'production' && 'webpack:main-dev',\n      'webpack:main',\n\n      ...(!modulePrefixPackageFields.includes('browser')\n        ? []\n        : [\n            // Browser builds\n            options.env !== 'production' && 'browser-dev',\n            'browser',\n          ]),\n      options.env !== 'production' && 'main-dev',\n      'main',\n    ].filter(ExcludesFalse) as string[],\n\n    aliasFields: [\n      ...([] as (string | false)[]).concat(\n        ...modulePrefixPackageFields.map((prefix: string): (\n          | string\n          | false\n        )[] => [\n          options.env !== 'production' && `module:aliases-${prefix}-dev`,\n          `module:aliases-${prefix}`,\n\n          // old webpack: syntax\n          options.env !== 'production' && `webpack:aliases-${prefix}-dev`,\n          `webpack:aliases-${prefix}`,\n        ]),\n      ),\n\n      options.env !== 'production' && 'module:aliases-dev',\n      'module:aliases',\n\n      // old webpack: syntax\n      options.env !== 'production' && 'webpack:aliases-dev',\n      'webpack:aliases',\n      'webpack',\n      modulePrefixPackageFields.includes('browser') &&\n        options.env !== 'production' &&\n        'browser-dev',\n      modulePrefixPackageFields.includes('browser') && 'browser',\n    ].filter(ExcludesFalse) as string[],\n\n    alias: options.aliases,\n\n    // Some libraries import Node modules but don't use them in the browser.\n    // Tell Webpack to provide empty mocks for them so importing them works.\n    // fs and module are used by source-map-support\n    fallback: {\n      fs: false,\n      module: false,\n    },\n  };\n}\n"],"names":["createOptions","options","aliases","babel","defines","entries","serviceWorkerEntry","undefined","env","process","NODE_ENV","hmr","allowlistExternalExtensions","includeModules","includePaths","jsLoaders","moduleRules","paths","src","build","optimization","plugins","prependPlugins","resolveLoaderModules","typescript","webpackPrefixPackageFields","createAppWebpackConfig","createWebpackConfig","wrapCreateWebpackConfig","appWebpackConfigPath","resolve","existsSync","console","info","appWebpackConfigCreator","require","error","config","addConfig","key","handler","ConsoleHandler","levels","INFO","logger","Logger","pluginName","FriendlyErrorsWebpackPlugin","constructor","bundleName","successMessage","context","apply","compiler","hooks","invalid","tap","log","done","stats","hasErrors","critical","toJson","errors","map","message","send","hasWarnings","warnings","warning","success","buildThrowOnError","Error","toString","createPobpackCompiler","webpackConfig","progressBar","webpack","stdout","isTTY","bar","progressPlugin","ProgressPlugin","percentage","msg","ProgressBar","colorette","bold","yellow","incomplete","complete","total","clear","stream","update","length","slice","promisifyRun","promisify","run","bind","promisifyClose","close","clean","output","path","execSync","then","watch","callback","err","ExcludesFalsy","Boolean","createModuleConfig","strictExportPresence","rules","parser","requireEnsure","test","include","includeModule","packageJson","findUp","sync","cwd","dirname","realpathSync","resolveFrom","filter","use","loader","babelrc","cacheDirectory","createPluginsConfig","CaseSensitivePathsPlugin","DefinePlugin","JSON","stringify","HotModuleReplacementPlugin","NormalModuleReplacementPlugin","ExcludesFalse","createResolveConfig","modulePrefixPackageFields","modules","extensions","mainFields","concat","prefix","includes","aliasFields","alias","fallback","fs","module"],"mappings":"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"}