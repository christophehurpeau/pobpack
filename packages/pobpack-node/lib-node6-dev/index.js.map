{"version":3,"sources":["../src/index.js"],"names":["buildThrowOnError","stats","hasErrors","Error","toString","hash","timings","chunks","chunkModules","modules","children","version","cached","cachedAssets","reasons","source","errorDetails","colors","process","stdout","isTTY","createCompiler","webpackConfig","compiler","bar","incomplete","total","width","clear","stream","apply","percentage","msg","clearLine","cursorTo","update","clearConsole","clean","output","path","run","done","then","watch","callback","err","createAppCompiler","options","build","hmr","undefined","watchAndRunCompiler","daemon","key","displayName","args","autorestart","start","on","stop","sendSIGUSR2","restart","watchAndRun"],"mappings":"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","file":"index.js","sourcesContent":["import { execSync } from 'child_process';\nimport readline from 'readline';\nimport { join } from 'path';\nimport promiseCallback from 'promise-callback-factory/src';\nimport ProgressBar from 'progress';\nimport webpack from 'webpack';\nimport ProgressPlugin from 'webpack/lib/ProgressPlugin';\nimport FriendlyErrorsWebpackPlugin from 'friendly-errors-webpack-plugin';\nimport createDaemon from 'springbokjs-daemon/src';\nimport createAppWebpackConfig from './createAppWebpackConfig';\n\nconst buildThrowOnError = (stats) => {\n  if (!stats.hasErrors()) {\n    return stats;\n  }\n\n  throw new Error(stats.toString({\n    hash: false,\n    timings: false,\n    chunks: false,\n    chunkModules: false,\n    modules: false,\n    children: true,\n    version: true,\n    cached: false,\n    cachedAssets: false,\n    reasons: false,\n    source: false,\n    errorDetails: false,\n    colors: process.stdout.isTTY,\n  }));\n};\n\nexport const createCompiler = (webpackConfig) => {\n  const compiler = webpack(webpackConfig);\n\n  if (process.stdout.isTTY) {\n    const bar = new ProgressBar(\n      'Building node bundle... :percent [:bar]',\n      { incomplete: ' ', total: 60, width: 50, clear: true, stream: process.stdout },\n    );\n    compiler.apply(new ProgressPlugin((percentage, msg) => {\n      if (percentage === 1) {\n        readline.clearLine(process.stdout);\n        readline.cursorTo(process.stdout, 0);\n      } else {\n        bar.update(percentage, { msg });\n      }\n    }));\n    // human-readable error messages\n    compiler.apply(new FriendlyErrorsWebpackPlugin({\n      clearConsole: false,\n    }));\n  }\n\n  return {\n    webpackConfig,\n    clean: () => webpackConfig.output.path && execSync(`rm -Rf ${webpackConfig.output.path}`),\n    run: () => promiseCallback(done => compiler.run(done)).then(buildThrowOnError),\n    watch: (callback) => compiler.watch({}, (err, stats) => {\n      if (err) return;\n      if (stats.hasErrors()) return;\n      buildThrowOnError(stats);\n      callback(stats);\n    }),\n  };\n};\n\nexport const createAppCompiler = options => (\n  createCompiler(createAppWebpackConfig(options))\n);\n\nexport const build = (options = {}) => {\n  const compiler = createAppCompiler({ ...options, hmr: false });\n  compiler.clean();\n  return compiler.run();\n};\n\nexport const watch = (options, callback) => {\n  if (typeof options === 'function') {\n    callback = options;\n    options = undefined;\n  }\n  const compiler = createAppCompiler({ ...options, hmr: true });\n  compiler.clean();\n  compiler.watch(callback);\n  return compiler;\n};\n\nexport const watchAndRunCompiler = (compiler, options = {}) => {\n  let daemon;\n  compiler.watch((stats) => {\n    if (!daemon) {\n      daemon = createDaemon({\n        key: options.key || 'pobpack-node',\n        displayName: options.displayName,\n        args: [join(compiler.webpackConfig.output.path)],\n        autorestart: true,\n      });\n      daemon.start();\n      process.on('exit', () => daemon.stop());\n    } else {\n      // already started, send a signal to ask hot reload\n      try {\n        daemon.sendSIGUSR2();\n      } catch (err) {\n        daemon.restart();\n      }\n    }\n  });\n};\n\nexport const watchAndRun = (options) => {\n  const compiler = createAppCompiler({ ...options, hmr: true });\n  compiler.clean();\n  watchAndRunCompiler(compiler);\n  return compiler;\n};\n"]}