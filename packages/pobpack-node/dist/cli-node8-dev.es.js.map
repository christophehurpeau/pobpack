{"version":3,"file":"cli-node8-dev.es.js","sources":["../src/createNodeWebpackConfig.ts","../src/index.ts","../src/cli.ts"],"sourcesContent":["// const fs = require('fs');\nimport path from 'path';\nimport nodeExternals from 'webpack-node-externals';\nimport {\n  webpack,\n  createModuleConfig,\n  createPluginsConfig,\n  createResolveConfig,\n} from 'pobpack-utils';\nimport { ConfigEntry, Options } from 'pobpack-types';\n\nconst ExcludesFalsy = (Boolean as any) as <T>(x: T | false | null | undefined) => x is T;\n\nexport default (options: Options): webpack.Configuration => ({\n  // production or development\n  mode: options.env === 'production' ? 'production' : 'development',\n\n  // Don't attempt to continue if there are any errors.\n  bail: options.env === 'production',\n\n  // Target node\n  target: 'node',\n\n  // get right stack traces\n  devtool: 'source-map',\n\n  optimization: {\n    noEmitOnErrors: true,\n    minimize: false,\n  },\n\n  // don't bundle node_modules dependencies\n  externals: nodeExternals({\n    importType: 'commonjs',\n    modulesFromFile: false,\n    whitelist: [\n      require.resolve('../hot'),\n      ...options.includeModules.map((module: string) => new RegExp(`^${module}(/|$)`)),\n    ],\n  }),\n\n  // __dirname and __filename\n  node: {\n    __filename: true,\n    __dirname: true,\n  },\n\n  // use cache\n  cache: options.hmr,\n\n  // bundle size is not relevant for node\n  performance: {\n    hints: false,\n  },\n\n  resolveLoader: {\n    modules: options.resolveLoaderModules || ['node_modules'],\n  },\n\n  resolve: createResolveConfig(['node'], {\n    ...options,\n    babel: {\n      presets: [require.resolve('../babel')],\n      ...options.babel,\n    },\n  }),\n\n  entry: options.entries.reduce((entries: { [key: string]: Array<string> }, entry: ConfigEntry) => {\n    if (typeof entry === 'string') entry = { key: entry, path: entry };\n    entries[entry.key] = [\n      options.hmr ? require.resolve('../hot') : undefined,\n      path.join(path.resolve(options.paths.src as string), entry.path),\n    ].filter(ExcludesFalsy);\n    return entries;\n  }, {}),\n\n  output: {\n    path: path.resolve(options.paths.build as string),\n    libraryTarget: 'commonjs2',\n    devtoolModuleFilenameTemplate: '[absolute-resource-path]',\n  },\n\n  module: createModuleConfig(options),\n\n  plugins: createPluginsConfig({\n    ...options,\n    plugins: [\n      options.hmr &&\n        new webpack.BannerPlugin({\n          banner: `require(\"${require.resolve('../source-map-support')}\");`,\n          raw: true,\n          entryOnly: false,\n          include: /\\.js$/,\n        }),\n      ...options.plugins,\n    ],\n  }),\n});\n","import { join } from 'path';\nimport createDaemon, { Daemon } from 'springbokjs-daemon';\nimport { createPobpackCompiler, createAppWebpackConfig, webpack } from 'pobpack-utils';\nimport { Options, PobpackCompiler, WatchCallback } from 'pobpack-types';\nimport createNodeWebpackConfig from './createNodeWebpackConfig';\n\nexport const createAppNodeCompiler = (options: Partial<Options>): PobpackCompiler =>\n  createPobpackCompiler('node', createAppWebpackConfig(createNodeWebpackConfig)(options));\n\nexport const build = (options = {}) => {\n  if (!process.env.NODE_ENV) process.env.NODE_ENV = 'production';\n  const compiler = createAppNodeCompiler({ ...options, hmr: false });\n  compiler.clean();\n  return compiler.run();\n};\n\nexport const watch = (options: Partial<Options>, callback: WatchCallback) => {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n  const compiler = createAppNodeCompiler({ ...options, hmr: true });\n  compiler.clean();\n  compiler.watch(callback);\n  return compiler;\n};\n\nexport interface RunOptions {\n  args?: Array<string | number>;\n  cwd?: string;\n  displayName?: string;\n  key?: string;\n}\n\nexport const watchAndRunCompiler = (compiler: PobpackCompiler, options: RunOptions = {}) => {\n  let daemon: Daemon;\n  return compiler.watch((stats: webpack.Stats) => {\n    if (!daemon) {\n      daemon = createDaemon({\n        key: options.key || 'pobpack-node',\n        displayName: options.displayName,\n        cwd: options.cwd,\n        args: [\n          join((compiler.webpackConfig.output && compiler.webpackConfig.output.path) || ''),\n          ...(options.args || []),\n        ],\n        // autoRestart: true,\n      });\n      daemon.start();\n      process.on('exit', () => daemon.stop());\n    } else if (daemon.hasExited()) {\n      daemon.start();\n    } else {\n      // already started, send a signal to ask hot reload\n      try {\n        daemon.sendSIGUSR2();\n      } catch (err) {\n        daemon.restart();\n      }\n    }\n  });\n};\n\nexport const watchAndRun = (options?: Partial<Options>): PobpackCompiler => {\n  const compiler = createAppNodeCompiler({ ...options, hmr: true });\n  compiler.clean();\n  watchAndRunCompiler(compiler);\n  return compiler;\n};\n","import { build, watchAndRun } from './index';\n\nconst cmd = process.argv[2];\n\nif (cmd === 'build') {\n  build();\n} else if (cmd === 'start' || !cmd) {\n  watchAndRun();\n} else {\n  console.log(`Invalid command: ${cmd}`);\n  process.exit(1);\n}\n"],"names":["ExcludesFalsy","Boolean","options","env","nodeExternals","require","resolve","includeModules","map","module","RegExp","hmr","resolveLoaderModules","createResolveConfig","babel","entries","reduce","entry","key","undefined","path","join","paths","src","filter","build","createModuleConfig","createPluginsConfig","webpack","BannerPlugin","plugins","createAppNodeCompiler","createPobpackCompiler","createAppWebpackConfig","createNodeWebpackConfig","process","NODE_ENV","compiler","clean","run","watchAndRunCompiler","daemon","watch","createDaemon","displayName","cwd","webpackConfig","output","args","start","on","stop","hasExited","sendSIGUSR2","err","restart","watchAndRun","cmd","argv","log","exit"],"mappings":"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"}