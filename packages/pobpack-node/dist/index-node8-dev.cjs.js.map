{"version":3,"file":"index-node8-dev.cjs.js","sources":["../src/createNodeWebpackConfig.ts","../src/index.ts"],"sourcesContent":["// const fs = require('fs');\nimport path from 'path';\nimport fs from 'fs';\nimport nodeExternals, {\n  Options as NodeExternalsOptions,\n} from 'webpack-node-externals';\nimport {\n  webpack,\n  createModuleConfig,\n  createPluginsConfig,\n  createResolveConfig,\n} from 'pobpack-utils';\nimport {\n  ConfigEntry,\n  Options,\n  FilledWebpackConfiguration,\n} from 'pobpack-types';\n\nconst ExcludesFalsy = (Boolean as any) as <T>(\n  x: T | false | null | undefined,\n) => x is T;\n\nconst createExternals = (options: Options) => {\n  const baseOptions: NodeExternalsOptions = {\n    importType: 'commonjs',\n    modulesFromFile: false,\n    whitelist: [\n      require.resolve('../hot'),\n      ...options.includeModules.map(\n        (module: string) => new RegExp(`^${module}(/|$)`),\n      ),\n    ],\n  };\n\n  const nodeModulesPaths = [];\n  let p = process.cwd();\n  do {\n    const nodeModulesCurrentPath = path.join(p, 'node_modules');\n    if (fs.existsSync(nodeModulesCurrentPath)) {\n      nodeModulesPaths.push(nodeModulesCurrentPath);\n    }\n    p = path.dirname(p);\n  } while (p !== '/');\n\n  return nodeModulesPaths.map((nodeModulesPath) =>\n    nodeExternals({ ...baseOptions, modulesDir: nodeModulesPath }),\n  );\n};\n\nexport default (options: Options): FilledWebpackConfiguration => ({\n  // production or development\n  mode: options.env === 'production' ? 'production' : 'development',\n\n  // Don't attempt to continue if there are any errors.\n  bail: options.env === 'production',\n\n  // Target node\n  target: 'node',\n\n  // get right stack traces\n  devtool: 'source-map',\n\n  optimization: {\n    noEmitOnErrors: true,\n    minimize: false,\n    ...options.optimization,\n  },\n\n  // don't bundle node_modules dependencies\n  externals: createExternals(options),\n\n  // __dirname and __filename\n  node: {\n    __filename: true,\n    __dirname: true,\n  },\n\n  // use cache\n  cache: options.hmr,\n\n  // bundle size is not relevant for node\n  performance: {\n    hints: false,\n  },\n\n  resolveLoader: {\n    modules: options.resolveLoaderModules || ['node_modules'],\n  },\n\n  resolve: createResolveConfig(['node'], {\n    ...options,\n    babel: {\n      presets: [require.resolve('../babel')],\n      ...options.babel,\n    },\n  }),\n\n  entry: options.entries.reduce(\n    (entries: { [key: string]: string[] }, entry: ConfigEntry) => {\n      if (typeof entry === 'string') entry = { key: entry, path: entry };\n      entries[entry.key] = [\n        options.hmr ? require.resolve('../hot') : undefined,\n        path.join(path.resolve(options.paths.src as string), entry.path),\n      ].filter(ExcludesFalsy);\n      return entries;\n    },\n    {},\n  ),\n\n  output: {\n    path: path.resolve(options.paths.build as string),\n    libraryTarget: 'commonjs2',\n    devtoolModuleFilenameTemplate: '[absolute-resource-path]',\n  },\n\n  module: createModuleConfig(options),\n\n  plugins: createPluginsConfig({\n    ...options,\n    plugins: [\n      options.hmr &&\n        new webpack.BannerPlugin({\n          banner: `require(\"${require.resolve('../source-map-support')}\");`,\n          raw: true,\n          entryOnly: false,\n          include: /\\.js$/,\n        }),\n      ...options.plugins,\n    ],\n  }),\n});\n","import { join } from 'path';\nimport createDaemon, { Daemon } from 'springbokjs-daemon';\nimport {\n  createPobpackCompiler,\n  createAppWebpackConfig,\n  webpack,\n} from 'pobpack-utils';\nimport { Options, PobpackCompiler, WatchCallback } from 'pobpack-types';\nimport { Watching } from 'webpack';\nimport createNodeWebpackConfig from './createNodeWebpackConfig';\n\nexport const createAppNodeCompiler = (\n  options: Partial<Options>,\n): PobpackCompiler =>\n  createPobpackCompiler(\n    'node',\n    createAppWebpackConfig(createNodeWebpackConfig)(options),\n  );\n\nexport const build = (options = {}) => {\n  if (!process.env.NODE_ENV) process.env.NODE_ENV = 'production';\n  const compiler = createAppNodeCompiler({ ...options, hmr: false });\n  compiler.clean();\n  return compiler.run();\n};\n\nexport const watch = (options: Partial<Options>, callback: WatchCallback) => {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n  const compiler = createAppNodeCompiler({ ...options, hmr: true });\n  compiler.clean();\n  compiler.watch(callback);\n  return compiler;\n};\n\nexport interface RunOptions {\n  args?: (string | number)[];\n  cwd?: string;\n  displayName?: string;\n  key?: string;\n}\n\nexport const watchAndRunCompiler = (\n  compiler: PobpackCompiler,\n  options: RunOptions = {},\n): Watching => {\n  let daemon: Daemon;\n  const watchingCompiler = compiler.watch((stats: webpack.Stats) => {\n    if (!daemon) {\n      daemon = createDaemon({\n        key: options.key || 'pobpack-node',\n        displayName: options.displayName,\n        cwd: options.cwd,\n        args: [\n          join(\n            (compiler.webpackConfig.output &&\n              compiler.webpackConfig.output.path) ||\n              '',\n          ),\n          ...(options.args || []),\n        ],\n        // autoRestart: true,\n      });\n      daemon.start();\n      process.on('exit', () => daemon.stop());\n    } else if (daemon.hasExited()) {\n      daemon.start();\n    } else {\n      // already started, send a signal to ask hot reload\n      try {\n        daemon.sendSIGUSR2();\n      } catch (err) {\n        daemon.restart();\n      }\n    }\n  });\n\n  return {\n    invalidate: () => {\n      watchingCompiler.invalidate();\n    },\n    close: (callback) => {\n      if (daemon) daemon.stop();\n      watchingCompiler.close(callback);\n    },\n  };\n};\n\nexport const watchAndRun = (options?: Partial<Options>): PobpackCompiler => {\n  const compiler = createAppNodeCompiler({ ...options, hmr: true });\n  compiler.clean();\n  watchAndRunCompiler(compiler);\n  return compiler;\n};\n"],"names":["ExcludesFalsy","Boolean","createExternals","options","baseOptions","importType","modulesFromFile","whitelist","require","resolve","includeModules","map","module","RegExp","nodeModulesPaths","p","process","cwd","nodeModulesCurrentPath","path","join","fs","existsSync","push","dirname","nodeModulesPath","nodeExternals","modulesDir","mode","env","bail","target","devtool","optimization","noEmitOnErrors","minimize","externals","node","__filename","__dirname","cache","hmr","performance","hints","resolveLoader","modules","resolveLoaderModules","createResolveConfig","babel","presets","entry","entries","reduce","key","undefined","paths","src","filter","output","build","libraryTarget","devtoolModuleFilenameTemplate","createModuleConfig","plugins","createPluginsConfig","webpack","BannerPlugin","banner","raw","entryOnly","include","createAppNodeCompiler","createPobpackCompiler","createAppWebpackConfig","createNodeWebpackConfig","NODE_ENV","compiler","clean","run","watch","callback","watchAndRunCompiler","daemon","watchingCompiler","createDaemon","displayName","args","webpackConfig","start","on","stop","hasExited","sendSIGUSR2","err","restart","invalidate","close","watchAndRun"],"mappings":"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"}