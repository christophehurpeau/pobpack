{"version":3,"file":"cli-node8-dev.cjs.js","sources":["../src/createNodeWebpackConfig.js","../src/index.js","../src/cli.js"],"sourcesContent":["// const fs = require('fs');\nimport path from 'path';\nimport nodeExternals from 'webpack-node-externals';\nimport {\n  webpack,\n  createModuleConfig,\n  createPluginsConfig,\n  createResolveConfig,\n  type OptionsType,\n} from 'pobpack-utils/src';\n\nexport default (options: OptionsType) => ({\n  // Don't attempt to continue if there are any errors.\n  bail: options.env === 'production',\n\n  // Target node\n  target: 'node',\n\n  // get right stack traces\n  devtool: 'source-map',\n\n  // don't bundle node_modules dependencies\n  externals: nodeExternals({\n    importType: 'commonjs',\n    modulesFromFile: false,\n    whitelist: [\n      require.resolve('../hot'),\n      ...options.includeModules.map(module => new RegExp(`^${module}(/|$)`)),\n    ],\n  }),\n\n  // __dirname and __filename\n  node: {\n    __filename: true,\n    __dirname: true,\n  },\n\n  // use cache\n  cache: options.hmr,\n\n  // bundle size is not relevant for node\n  performance: {\n    hints: false,\n  },\n\n  resolveLoader: {\n    modules: options.resolveLoaderModules || ['node_modules'],\n  },\n\n  resolve: createResolveConfig(['node'], {\n    ...options,\n    babel: {\n      presets: [require.resolve('../babel')],\n      ...options.babel,\n    },\n  }),\n\n  entry: options.entries.reduce((entries, entry) => {\n    if (typeof entry === 'string') entry = { key: entry, path: entry };\n    entries[entry.key] = [\n      options.hmr && require.resolve('../hot'),\n      path.join(path.resolve(options.paths.src), entry.path),\n    ].filter(Boolean);\n    return entries;\n  }, {}),\n\n  output: {\n    path: path.resolve(options.paths.build),\n    libraryTarget: 'commonjs2',\n    devtoolModuleFilenameTemplate: '[absolute-resource-path]',\n  },\n\n  module: createModuleConfig(options),\n\n  plugins: createPluginsConfig({\n    ...options,\n    plugins: [\n      options.hmr &&\n        new webpack.BannerPlugin({\n          banner: `require(\"${require.resolve('../source-map-support')}\");`,\n          raw: true,\n          entryOnly: false,\n          include: /\\.js$/,\n        }),\n      ...options.plugins,\n    ],\n  }),\n});\n","import { join } from 'path';\nimport createDaemon from 'springbokjs-daemon/src';\nimport {\n  createPobpackCompiler,\n  createAppWebpackConfig,\n  type PobpackCompilerType,\n  type WatchCallbackType,\n} from 'pobpack-utils';\nimport createNodeWebpackConfig from './createNodeWebpackConfig';\n\nexport const createAppNodeCompiler = (options): PobpackCompilerType =>\n  createPobpackCompiler('node', createAppWebpackConfig(createNodeWebpackConfig)(options));\n\nexport const build = (options = {}) => {\n  const compiler = createAppNodeCompiler({ ...options, hmr: false });\n  compiler.clean();\n  return compiler.run();\n};\n\nexport const watch = (options, callback: WatchCallbackType) => {\n  if (typeof options === 'function') {\n    callback = options;\n    options = undefined;\n  }\n  const compiler = createAppNodeCompiler({ ...options, hmr: true });\n  compiler.clean();\n  compiler.watch(callback);\n  return compiler;\n};\n\ntype RunOptions = {|\n  key?: ?string,\n  displayName?: ?string,\n  args?: ?Array<string | number>,\n  cwd?: ?string,\n|};\n\nexport const watchAndRunCompiler = (compiler: PobpackCompilerType, options: RunOptions = {}) => {\n  let daemon;\n  return compiler.watch(stats => {\n    if (!daemon) {\n      daemon = createDaemon({\n        key: options.key || 'pobpack-node',\n        displayName: options.displayName,\n        cwd: options.cwd,\n        args: [join(compiler.webpackConfig.output.path), ...(options.args || [])],\n        // autoRestart: true,\n      });\n      daemon.start();\n      process.on('exit', () => daemon.stop());\n    } else {\n      // already started, send a signal to ask hot reload\n      try {\n        daemon.sendSIGUSR2();\n      } catch (err) {\n        daemon.restart();\n      }\n    }\n  });\n};\n\nexport const watchAndRun = options => {\n  const compiler = createAppNodeCompiler({ ...options, hmr: true });\n  compiler.clean();\n  watchAndRunCompiler(compiler);\n  return compiler;\n};\n","import { build, watchAndRun } from './index';\n\nconst cmd = process.argv[2];\n\nif (cmd === 'build') {\n  build();\n} else if (cmd === 'start' || !cmd) {\n  watchAndRun();\n} else {\n  console.log(`Invalid command: ${cmd}`);\n  process.exit(1);\n}\n"],"names":["options","env","nodeExternals","require","resolve","includeModules","map","module","RegExp","hmr","resolveLoaderModules","createResolveConfig","babel","entries","reduce","entry","key","path","join","paths","src","filter","Boolean","build","createModuleConfig","createPluginsConfig","webpack","BannerPlugin","plugins","createAppNodeCompiler","createPobpackCompiler","createAppWebpackConfig","createNodeWebpackConfig","compiler","clean","run","watchAndRunCompiler","daemon","watch","createDaemon","displayName","cwd","webpackConfig","output","args","start","on","stop","sendSIGUSR2","err","restart","watchAndRun","cmd","process","argv","log","exit"],"mappings":"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"}