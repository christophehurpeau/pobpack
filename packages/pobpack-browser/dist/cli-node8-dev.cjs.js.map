{"version":3,"file":"cli-node8-dev.cjs.js","sources":["../src/createBrowserWebpackConfig.js","../src/index.js","../src/cli.js"],"sourcesContent":["import path from 'path';\nimport {\n  createModuleConfig,\n  createPluginsConfig,\n  createResolveConfig,\n  type OptionsType,\n} from 'pobpack-utils/src';\nimport hotLoaderBabelPlugin from 'react-hot-loader/babel';\n\ntype BrowserTargetType = 'modern' | 'all';\n\nexport const MODERN = 'modern';\nexport const ALL = 'all';\nexport const TARGETS = [ALL, MODERN];\n\nexport default (target: BrowserTargetType) => (options: OptionsType) => ({\n  // production or development\n  mode: options.env === 'production' ? 'production' : 'development',\n\n  // Don't attempt to continue if there are any errors.\n  bail: options.env === 'production',\n\n  // Target web\n  target: 'web',\n\n  // get right stack traces\n  devtool: options.env === 'production' ? 'nosources-source-map' : 'source-map',\n\n  optimization: {\n    noEmitOnErrors: true,\n    minimize: false,\n  },\n\n  // use cache\n  cache: options.hmr,\n\n  devServer: {\n    // don't watch node_modules (improve cpu and memory usage)\n    watchOptions: {\n      ignored: /node_modules/,\n    },\n  },\n\n  // Some libraries import Node modules but don't use them in the browser.\n  // Tell Webpack to provide empty mocks for them so importing them works.\n  // fs and module are used by source-map-support\n  node: {\n    fs: 'empty',\n    module: 'empty',\n  },\n\n  resolveLoader: {\n    modules: options.resolveLoaderModules || ['node_modules'],\n  },\n\n  resolve: createResolveConfig(\n    [target === MODERN && 'modern-browsers', 'browser'].filter(Boolean),\n    {\n      ...options,\n      babel: {\n        presets: [require.resolve('../babel')],\n        ...options.babel,\n        plugins: [options.hmr && hotLoaderBabelPlugin, ...(options.babel.plugins || [])].filter(\n          Boolean,\n        ),\n      },\n    },\n  ),\n\n  entry: options.entries.reduce((entries, entry) => {\n    if (typeof entry === 'string') entry = { key: entry, path: entry };\n    entries[entry.key] = [\n      target !== MODERN && require.resolve('babel-regenerator-runtime'),\n      options.hmr && require.resolve('react-hot-loader/patch'),\n      options.hmr && require.resolve('react-dev-utils/webpackHotDevClient'),\n      path.join(path.resolve(options.paths.src), entry.path),\n    ].filter(Boolean);\n    return entries;\n  }, {}),\n\n  output: {\n    path: path.resolve(options.paths.build),\n    devtoolModuleFilenameTemplate: 'file://[absolute-resource-path]',\n  },\n\n  module: createModuleConfig(options),\n\n  plugins: createPluginsConfig(options),\n});\n","import WebpackDevServer from 'webpack-dev-server';\nimport {\n  createPobpackCompiler,\n  createAppWebpackConfig,\n  type OptionsType,\n  type PobpackCompilerType,\n  type WatchCallbackType,\n} from 'pobpack-utils/src';\nimport createBrowserWebpackConfig, { TARGETS, ALL, MODERN } from './createBrowserWebpackConfig';\n\nexport { TARGETS, ALL, MODERN };\n\nexport const createAppBrowserCompiler = (\n  target: string,\n  options: OptionsType,\n  compilerOptions,\n): PobpackCompilerType =>\n  createPobpackCompiler(\n    target,\n    createAppWebpackConfig(createBrowserWebpackConfig(target))({\n      ...options,\n      paths: { build: 'public', ...options.paths },\n    }),\n    compilerOptions,\n  );\n\nexport const build = (options = {}) => {\n  const compilers = TARGETS.map(t => createAppBrowserCompiler(t, { ...options, hmr: false }));\n  compilers[0].clean();\n  return compilers.map(compiler => compiler.run());\n};\n\nexport const watch = (options, callback: WatchCallbackType) => {\n  if (typeof options === 'function') {\n    callback = options;\n    options = undefined;\n  }\n  const compiler = createAppBrowserCompiler(MODERN, { ...options, hmr: true });\n  compiler.clean();\n  compiler.watch(callback);\n  return compiler;\n};\n\ntype RunOptionsType = {\n  host?: string,\n  port: number,\n  https?: ?boolean,\n};\n\nexport const runDevServer = (compiler: PobpackCompilerType, options: RunOptionsType) => {\n  const { host, port, https, ...webpackDevServerOptions } = options;\n  const browserDevServer = new WebpackDevServer(compiler.compiler, {\n    hot: true,\n    // stats: 'errors-only',\n    quiet: true, // errors are displayed with friendly-errors plugin\n    // without page refresh as fallback in case of build failures: hotOnly: true,\n    https,\n    overlay: true,\n    ...webpackDevServerOptions,\n  });\n  browserDevServer.listen(port, host);\n  return browserDevServer;\n};\n\nexport const watchAndRunDevServer = (options: OptionsType, runOptions: RunOptionsType) => {\n  const url = `http${runOptions.https ? 's' : ''}://localhost:${runOptions.port}`;\n  const compiler = createAppBrowserCompiler(\n    MODERN,\n    { ...options, hmr: true },\n    {\n      successMessage: `Your application is running here: ${url}`,\n    },\n  );\n  compiler.clean();\n  const webpackDevServer = runDevServer(compiler, runOptions);\n  return { ...compiler, webpackDevServer };\n};\n","import { build, watchAndRunDevServer } from './index';\n\nconst cmd = process.argv[2];\n\nif (cmd === 'build') {\n  build();\n} else if (cmd === 'start' || !cmd) {\n  watchAndRunDevServer({}, { port: Number(process.env.PORT) || 8080, https: false });\n} else {\n  console.log(`Invalid command: ${cmd}`);\n  process.exit(1);\n}\n"],"names":["t","MODERN","ALL","TARGETS","target","options","env","hmr","resolveLoaderModules","createResolveConfig","filter","Boolean","require","resolve","babel","hotLoaderBabelPlugin","plugins","entries","reduce","entry","key","path","join","paths","src","build","createModuleConfig","createPluginsConfig","createAppBrowserCompiler","compilerOptions","createPobpackCompiler","createAppWebpackConfig","createBrowserWebpackConfig","compilers","map","clean","compiler","run","runDevServer","host","port","https","webpackDevServerOptions","browserDevServer","WebpackDevServer","listen","watchAndRunDevServer","runOptions","url","webpackDevServer","cmd","process","argv","Number","PORT","log","exit"],"mappings":"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"}