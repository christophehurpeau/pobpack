{"version":3,"file":"index-node10.cjs.js","sources":["../src/createBrowserWebpackConfig.ts","../src/index.ts"],"sourcesContent":["import path from 'path';\nimport {\n  createModuleConfig,\n  createPluginsConfig,\n  createResolveConfig,\n  webpack,\n} from 'pobpack-utils';\nimport { Options, ConfigEntry } from 'pobpack-types';\n\nexport type BrowserTargetType = 'modern' | 'all';\n\nexport const MODERN = 'modern';\nexport const ALL = 'all';\nexport const TARGETS: Array<BrowserTargetType> = [ALL, MODERN];\n\nconst ExcludesFalsy = (Boolean as any) as <T>(x: T | boolean | null | undefined) => x is T;\n\nexport default (target: BrowserTargetType) => (options: Options): webpack.Configuration => ({\n  // production or development\n  mode: options.env === 'production' ? 'production' : 'development',\n\n  // Don't attempt to continue if there are any errors.\n  bail: options.env === 'production',\n\n  // Target web\n  target: 'web',\n\n  // get right stack traces\n  devtool: options.env === 'production' ? 'nosources-source-map' : 'source-map',\n\n  optimization: {\n    noEmitOnErrors: true,\n    minimize: options.env === 'production',\n  },\n\n  // use cache\n  cache: options.hmr,\n\n  devServer: {\n    // don't watch node_modules (improve cpu and memory usage)\n    watchOptions: {\n      ignored: /node_modules/,\n    },\n  },\n\n  // Some libraries import Node modules but don't use them in the browser.\n  // Tell Webpack to provide empty mocks for them so importing them works.\n  // fs and module are used by source-map-support\n  node: {\n    fs: 'empty',\n    module: 'empty',\n  },\n\n  resolveLoader: {\n    modules: options.resolveLoaderModules || ['node_modules'],\n  },\n\n  resolve: createResolveConfig(\n    [target === MODERN ? 'modern-browsers' : undefined, 'browser'].filter(ExcludesFalsy),\n    {\n      ...options,\n      babel: {\n        presets: [require.resolve('../babel')],\n        ...options.babel,\n        plugins: [\n          options.hmr && require.resolve('react-hot-loader/babel'),\n          ...(options.babel.plugins || []),\n        ].filter(ExcludesFalsy),\n      },\n    },\n  ),\n\n  entry: options.entries.reduce((entries: { [key: string]: Array<string> }, entry: ConfigEntry) => {\n    if (typeof entry === 'string') entry = { key: entry, path: entry };\n    entries[entry.key] = [\n      // options.env !== 'production' && require.resolve('../source-map-support'),\n      target !== MODERN && require.resolve('regenerator-runtime/runtime'),\n      options.hmr && require.resolve('react-hot-loader/patch'),\n      options.hmr && require.resolve('react-dev-utils/webpackHotDevClient'),\n      path.join(path.resolve(options.paths.src as string), entry.path),\n    ].filter(ExcludesFalsy);\n    return entries;\n  }, {}),\n\n  output: {\n    path: path.resolve(options.paths.build as string),\n    // devtoolModuleFilenameTemplate: 'file://[absolute-resource-path]',\n  },\n\n  module: createModuleConfig(options),\n\n  plugins: createPluginsConfig(options),\n});\n","import WebpackDevServer from 'webpack-dev-server';\nimport { Options, PobpackCompiler, WatchCallback, CreateCompilerOptions } from 'pobpack-types';\nimport { createPobpackCompiler, createAppWebpackConfig } from 'pobpack-utils';\nimport createBrowserWebpackConfig, {\n  TARGETS,\n  ALL,\n  MODERN,\n  BrowserTargetType,\n} from './createBrowserWebpackConfig';\n\nexport { TARGETS, ALL, MODERN };\n\nexport const createAppBrowserCompiler = (\n  target: BrowserTargetType,\n  options: Partial<Options>,\n  compilerOptions?: CreateCompilerOptions,\n): PobpackCompiler =>\n  createPobpackCompiler(\n    target,\n    createAppWebpackConfig(createBrowserWebpackConfig(target))({\n      entries: [{ key: target, path: 'index' }], // override default entry\n      ...options,\n      paths: { build: 'public', ...options.paths },\n    }),\n    compilerOptions,\n  );\n\nexport const build = (options = {}) => {\n  if (!process.env.NODE_ENV) process.env.NODE_ENV = 'production';\n  const compilers = TARGETS.map(t => createAppBrowserCompiler(t, { ...options, hmr: false }));\n  compilers[0].clean();\n  return compilers.map(compiler => compiler.run());\n};\n\nexport const watch = (options: Partial<Options>, callback?: WatchCallback) => {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n  const compiler = createAppBrowserCompiler(MODERN, { ...options, hmr: true });\n  compiler.clean();\n  compiler.watch(callback as WatchCallback);\n  return compiler;\n};\n\nexport interface RunOptions {\n  host?: string;\n  https?: boolean;\n  port: number;\n}\n\nexport const runDevServer = (compiler: PobpackCompiler, options: RunOptions) => {\n  const { host, port, https, ...webpackDevServerOptions } = options;\n  const browserDevServer = new WebpackDevServer(compiler.compiler, {\n    hot: true,\n    // stats: 'errors-only',\n    quiet: true, // errors are displayed with friendly-errors plugin\n    // without page refresh as fallback in case of build failures: hotOnly: true,\n    https,\n    overlay: true,\n    ...webpackDevServerOptions,\n  });\n  browserDevServer.listen(port, host as string); // note: host can be undefined, but types does not support it\n  return browserDevServer;\n};\n\nexport type PobpackBrowserCompiler = PobpackCompiler & { webpackDevServer: WebpackDevServer };\n\nexport const watchAndRunDevServer = (\n  options: Partial<Options>,\n  runOptions: RunOptions,\n): PobpackBrowserCompiler => {\n  const url = `http${runOptions.https ? 's' : ''}://localhost:${runOptions.port}`;\n  const compiler: PobpackCompiler = createAppBrowserCompiler(\n    MODERN,\n    { ...options, hmr: true },\n    {\n      successMessage: `Your application is running here: ${url}`,\n    },\n  );\n  compiler.clean();\n  const webpackDevServer = runDevServer(compiler, runOptions);\n  return { ...compiler, webpackDevServer };\n};\n"],"names":["MODERN","ALL","TARGETS","ExcludesFalsy","Boolean","target","options","env","hmr","resolveLoaderModules","createResolveConfig","undefined","filter","require","resolve","babel","plugins","entries","reduce","entry","key","path","join","paths","src","build","createModuleConfig","createPluginsConfig","createAppBrowserCompiler","compilerOptions","createPobpackCompiler","createAppWebpackConfig","createBrowserWebpackConfig","process","NODE_ENV","compilers","map","t","clean","compiler","run","watch","callback","runDevServer","webpackDevServerOptions","browserDevServer","WebpackDevServer","listen","port","host","watchAndRunDevServer","runOptions","url","https","webpackDevServer"],"mappings":";;;;;;;;;;MAWaA,SAAS,QAAf;AACP,MAAaC,MAAM,KAAZ;AACP,MAAaC,UAAoC,iBAA1C;AAEP,MAAMC,gBAAiBC,OAAvB;AAEA,kCAAgBC,MAAD,IAAgCC,OAAD,KAA8C;;QAEpFA,QAAQC,GAAR,KAAgB,YAAhB,GAA+B,YAA/B,GAA8C,aAFsC;;QAKpFD,QAAQC,GAAR,KAAgB,YALoE;;UAQlF,KARkF;;WAWjFD,QAAQC,GAAR,KAAgB,YAAhB,GAA+B,sBAA/B,GAAwD,YAXyB;gBAa5E;oBACI,IADJ;cAEFD,QAAQC,GAAR,KAAgB;GAf8D;;SAmBnFD,QAAQE,GAnB2E;aAqB/E;;kBAEK;eACH;;GAxB6E;;;;QA+BpF;QACA,OADA;YAEI;GAjCgF;iBAoC3E;aACJF,QAAQG,oBAAR,IAAgC,CAAC,cAAD;GArC+C;WAwCjFC,iCACP,CAACL,sBAAoB,iBAApB,GAAwCM,SAAzC,EAAoD,SAApD,EAA+DC,MAA/D,CAAsET,aAAtE,CADO,EAEP,EACE,GAAGG,OADL;WAES;eACI,CAACO,QAAQC,OAAR,CAAgB,UAAhB,CAAD,CADJ;SAEFR,QAAQS,KAFN;eAGI,CACPT,QAAQE,GAAR,IAAeK,QAAQC,OAAR,CAAgB,wBAAhB,CADR,EAEP,IAAIR,QAAQS,KAAR,CAAcC,OAAd,IAAyB,EAA7B,CAFO,EAGPJ,MAHO,CAGAT,aAHA;;GAPN,CAxCiF;SAuDnFG,QAAQW,OAAR,CAAgBC,MAAhB,CAAuB,CAACD,OAAD,EAA4CE,KAA5C,KAAmE;QAC3F,OAAOA,KAAP,KAAiB,QAArB,EAA+BA,QAAQ;WAAOA,KAAP;YAAoBA;KAA5B;YACvBA,MAAMC,GAAd,IAAqB;2BAEEP,QAAQC,OAAR,CAAgB,6BAAhB,CAFF,EAGnBR,QAAQE,GAAR,IAAeK,QAAQC,OAAR,CAAgB,wBAAhB,CAHI,EAInBR,QAAQE,GAAR,IAAeK,QAAQC,OAAR,CAAgB,qCAAhB,CAJI,EAKnBO,KAAKC,IAAL,CAAUD,KAAKP,OAAL,CAAaR,QAAQiB,KAAR,CAAcC,GAA3B,CAAV,EAAqDL,MAAME,IAA3D,CALmB,EAMnBT,MANmB,CAMZT,aANY,CAArB;WAOOc,OAAP;GATK,EAUJ,EAVI,CAvDmF;UAmElF;UACAI,KAAKP,OAAL,CAAaR,QAAQiB,KAAR,CAAcE,KAA3B,CADA;;GAnEkF;UAwElFC,gCAAmBpB,OAAnB,CAxEkF;WA0EjFqB,iCAAoBrB,OAApB;CA1EmC,CAA9C;;MCLasB,2BAA2B,CACtCvB,MADsC,EAEtCC,OAFsC,EAGtCuB,eAHsC,KAKtCC,mCACEzB,MADF,EAEE0B,oCAAuBC,2BAA2B3B,MAA3B,CAAvB,EAA2D;WAChD,CAAC;SAAOA,MAAP;UAAqB;GAAtB,CADgD;;KAEtDC,OAFsD;SAGlD;WAAS,QAAT;OAAsBA,QAAQiB;;CAHvC,CAFF,EAOEM,eAPF,CALK;AAeP,MAAaJ,QAAQ,CAACnB,UAAU,EAAX,KAAkB;MACjC,CAAC2B,QAAQ1B,GAAR,CAAY2B,QAAjB,EAA2BD,QAAQ1B,GAAR,CAAY2B,QAAZ,GAAuB,YAAvB;QACrBC,YAAYjC,QAAQkC,GAAR,CAAYC,KAAKT,yBAAyBS,CAAzB,EAA4B,EAAE,GAAG/B,OAAL;SAAmB;GAA/C,CAAjB,CAAlB;YACU,CAAV,EAAagC,KAAb;SACOH,UAAUC,GAAV,CAAcG,YAAYA,SAASC,GAAT,EAA1B,CAAP;CAJK;AAOP,MAAaC,QAAQ,CAACnC,OAAD,EAA4BoC,QAA5B,KAAyD;MACxE,OAAOpC,OAAP,KAAmB,UAAvB,EAAmC;eACtBA,OAAX;cACU,EAAV;;;QAEIiC,WAAWX,yBAAyB5B,MAAzB,EAAiC,EAAE,GAAGM,OAAL;SAAmB;GAApD,CAAjB;WACSgC,KAAT;WACSG,KAAT,CAAeC,QAAf;SACOH,QAAP;CARK;AAiBP,MAAaI,eAAe,CAACJ,QAAD,EAA4BjC,OAA5B,KAAoD;QACxE;QAAA;QAAA;SAAA;OAAwBsC;MAA4BtC,OAA1D;QACMuC,mBAAmB,IAAIC,gBAAJ,CAAqBP,SAASA,QAA9B,EAAwC;SAC1D,IAD0D;;WAGxD,IAHwD;;;SAAA;aAMtD,IANsD;OAO5DK;GAPoB,CAAzB;mBASiBG,MAAjB,CAAwBC,IAAxB,EAA8BC,IAA9B,EAX8E;;SAYvEJ,gBAAP;CAZK;AAiBP,MAAaK,uBAAuB,CAClC5C,OADkC,EAElC6C,UAFkC,KAGP;QACrBC,MAAO,OAAMD,WAAWE,KAAX,GAAmB,GAAnB,GAAyB,EAAG,gBAAeF,WAAWH,IAAK,EAA9E;QACMT,WAA4BX,yBAChC5B,MADgC,EAEhC,EAAE,GAAGM,OAAL;SAAmB;GAFa,EAGhC;oBACmB,qCAAoC8C,GAAI;GAJ3B,CAAlC;WAOSd,KAAT;QACMgB,mBAAmBX,aAAaJ,QAAb,EAAuBY,UAAvB,CAAzB;SACO,EAAE,GAAGZ,QAAL;;GAAP;CAdK;;;;;;;;;;;"}