{"version":3,"file":"cli-node10.es.js","sources":["../src/createBrowserWebpackConfig.ts","../src/index.ts","../src/cli.ts"],"sourcesContent":["import path from 'path';\nimport {\n  createModuleConfig,\n  createPluginsConfig,\n  createResolveConfig,\n} from 'pobpack-utils';\nimport {\n  Options,\n  ConfigEntry,\n  FilledWebpackConfiguration,\n} from 'pobpack-types';\n\nexport type BrowserTargetType = 'modern' | 'all';\n\nexport const MODERN = 'modern';\nexport const ALL = 'all';\nexport const TARGETS: BrowserTargetType[] = [ALL, MODERN];\n\nconst ExcludesFalsy = (Boolean as unknown) as <T>(\n  x: T | boolean | null | undefined,\n) => x is T;\n\nexport default function createBrowserWebpackConfig(target: BrowserTargetType) {\n  return (options: Options): FilledWebpackConfiguration => ({\n    // production or development\n    mode: options.env === 'production' ? 'production' : 'development',\n\n    // Don't attempt to continue if there are any errors.\n    bail: options.env === 'production',\n\n    // Target web\n    target: 'web',\n\n    // get right stack traces\n    devtool:\n      options.env === 'production' ? 'nosources-source-map' : 'source-map',\n\n    optimization: {\n      noEmitOnErrors: true,\n      minimize: options.env === 'production',\n      ...options.optimization,\n    },\n\n    // use cache\n    cache: options.hmr,\n\n    devServer: {\n      // don't watch node_modules (improve cpu and memory usage)\n      watchOptions: {\n        ignored: /node_modules/,\n      },\n    },\n\n    // Some libraries import Node modules but don't use them in the browser.\n    // Tell Webpack to provide empty mocks for them so importing them works.\n    // fs and module are used by source-map-support\n    node: {\n      fs: 'empty',\n      module: 'empty',\n    },\n\n    resolveLoader: {\n      modules: options.resolveLoaderModules || ['node_modules'],\n    },\n\n    resolve: createResolveConfig(\n      [target === MODERN ? 'modern-browsers' : undefined, 'browser'].filter(\n        ExcludesFalsy,\n      ),\n      {\n        ...options,\n        aliases: {\n          ...options.aliases,\n          'react-dom': require.resolve('@hot-loader/react-dom'),\n        },\n        babel: {\n          presets: [require.resolve('../babel')],\n          ...options.babel,\n          plugins: [\n            ...(options.babel.plugins || []),\n            options.hmr\n              ? require.resolve('react-hot-loader/dist/babel.development.js')\n              : // removes import { hot } from 'react-hot-loader';\n                require.resolve(\n                  'react-hot-loader/dist/babel.production.min.js',\n                ),\n          ].filter(ExcludesFalsy),\n        },\n      },\n    ),\n\n    entry: options.entries.reduce(\n      (entries: { [key: string]: string[] }, entry: ConfigEntry) => {\n        if (typeof entry === 'string') entry = { key: entry, path: entry };\n        entries[entry.key] = [\n          // options.env !== 'production' && require.resolve('../source-map-support'),\n          target !== MODERN && require.resolve('regenerator-runtime/runtime'),\n          options.hmr && require.resolve('react-hot-loader/patch'),\n          options.hmr && require.resolve('react-dev-utils/webpackHotDevClient'),\n          path.join(path.resolve(options.paths.src as string), entry.path),\n        ].filter(ExcludesFalsy);\n        return entries;\n      },\n      {},\n    ),\n\n    output: {\n      path: path.resolve(options.paths.build as string),\n      // Point sourcemap entries to original disk location\n\n      // devtoolModuleFilenameTemplate: 'file://[absolute-resource-path]',\n      devtoolModuleFilenameTemplate:\n        // eslint-disable-next-line no-nested-ternary\n        options.env === 'production'\n          ? (info) =>\n              path\n                .relative(\n                  options.paths.src as string,\n                  info.absoluteResourcePath,\n                )\n                .replace(/\\\\/g, '/')\n          : options.env === 'development'\n          ? (info) =>\n              path.resolve(info.absoluteResourcePath).replace(/\\\\/g, '/')\n          : undefined,\n    },\n\n    module: createModuleConfig(options),\n\n    plugins: createPluginsConfig(options),\n  });\n}\n","import WebpackDevServer, {\n  Configuration as WebpackDevServerConfiguration,\n} from 'webpack-dev-server';\nimport {\n  Options,\n  PobpackCompiler,\n  WatchCallback,\n  CreateCompilerOptions,\n} from 'pobpack-types';\nimport { createPobpackCompiler, createAppWebpackConfig } from 'pobpack-utils';\nimport createLaunchEditorMiddleware from 'react-dev-utils/errorOverlayMiddleware';\nimport evalSourceMapMiddleware from 'react-dev-utils/evalSourceMapMiddleware';\nimport noopServiceWorkerMiddleware from 'react-dev-utils/noopServiceWorkerMiddleware';\nimport createBrowserWebpackConfig, {\n  TARGETS,\n  ALL,\n  MODERN,\n  BrowserTargetType,\n} from './createBrowserWebpackConfig';\n\nexport { TARGETS, ALL, MODERN };\n\nexport const createAppBrowserCompiler = (\n  target: BrowserTargetType,\n  options: Partial<Options>,\n  compilerOptions?: CreateCompilerOptions,\n): PobpackCompiler =>\n  createPobpackCompiler(\n    target,\n    createAppWebpackConfig(createBrowserWebpackConfig(target))({\n      entries: [{ key: target, path: 'index' }], // override default entry\n      ...options,\n      paths: { build: 'public', ...options.paths },\n    }),\n    compilerOptions,\n  );\n\nexport const build = (options = {}) => {\n  if (!process.env.NODE_ENV) process.env.NODE_ENV = 'production';\n  const compilers = TARGETS.map((t) =>\n    createAppBrowserCompiler(t, { ...options, hmr: false }),\n  );\n  compilers[0].clean();\n  return compilers.map((compiler) => compiler.run());\n};\n\nexport const watch = (options: Partial<Options>, callback?: WatchCallback) => {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n  const compiler = createAppBrowserCompiler(MODERN, { ...options, hmr: true });\n  compiler.clean();\n  compiler.watch(callback as WatchCallback);\n  return compiler;\n};\n\ntype Omit<T, K extends keyof T> = Pick<T, Exclude<keyof T, K>>;\n\nexport interface RunOptions\n  extends Omit<\n    WebpackDevServerConfiguration,\n    'hot' | 'quiet' | 'overlay' | 'compress' | 'before'\n  > {\n  host?: string;\n  https?: boolean;\n  port: number;\n}\n\nexport const runDevServer = (\n  compiler: PobpackCompiler,\n  options: RunOptions,\n) => {\n  const { host, port, https, ...webpackDevServerOptions } = options;\n  const browserDevServer = new WebpackDevServer(compiler.compiler, {\n    hot: true,\n    // stats: 'errors-only',\n    quiet: true, // errors are displayed with friendly-errors plugin\n    overlay: false, // We use create-react-app-overlay\n    compress: true, // Enable gzip compression of generated files\n    // Silence WebpackDevServer's logs. Still displays errors and warnings\n    clientLogLevel: 'none',\n\n    // without page refresh as fallback in case of build failures: hotOnly: true,\n    https,\n    ...webpackDevServerOptions,\n\n    // @ts-ignore\n    before(app: any, server: any) {\n      // https://github.com/facebook/create-react-app/blob/30ee52cf3b2cbb6ac70999c02b1196bcaba8d4ca/packages/react-scripts/config/webpackDevServer.config.js#L99\n      // This lets us fetch source contents from webpack for the error overlay\n      app.use(evalSourceMapMiddleware(server));\n      // This lets us open files from the runtime error overlay.\n      app.use(createLaunchEditorMiddleware());\n\n      // This service worker file is effectively a 'no-op' that will reset any\n      // previous service worker registered for the same host:port combination.\n      // We do this in development to avoid hitting the production cache if\n      // it used the same host and port.\n      // https://github.com/facebook/create-react-app/issues/2272#issuecomment-302832432\n      app.use(noopServiceWorkerMiddleware());\n    },\n  });\n  browserDevServer.listen(port, host as string); // note: host can be undefined, but types does not support it\n  return browserDevServer;\n};\n\nexport type PobpackBrowserCompiler = PobpackCompiler & {\n  webpackDevServer: WebpackDevServer;\n};\n\nexport const watchAndRunDevServer = (\n  options: Partial<Options>,\n  runOptions: RunOptions,\n): PobpackBrowserCompiler => {\n  const url = `http${runOptions.https ? 's' : ''}://localhost:${\n    runOptions.port\n  }`;\n  const compiler: PobpackCompiler = createAppBrowserCompiler(\n    MODERN,\n    { ...options, hmr: true },\n    {\n      successMessage: `Your application is running here: ${url}`,\n    },\n  );\n  compiler.clean();\n  const webpackDevServer = runDevServer(compiler, runOptions);\n  return { ...compiler, webpackDevServer };\n};\n","/* eslint-disable unicorn/no-process-exit */\nimport { build, watchAndRunDevServer } from '.';\n\nconst cmd = process.argv[2];\n\nif (cmd === 'build') {\n  build();\n} else if (cmd === 'start' || !cmd) {\n  watchAndRunDevServer(\n    {},\n    { port: Number(process.env.PORT) || 8080, https: false },\n  );\n} else {\n  console.log(`Invalid command: ${cmd}`);\n  process.exit(1);\n}\n"],"names":["MODERN","TARGETS","ExcludesFalsy","Boolean","createBrowserWebpackConfig","target","options","mode","env","bail","devtool","optimization","noEmitOnErrors","minimize","cache","hmr","devServer","watchOptions","ignored","node","fs","module","resolveLoader","modules","resolveLoaderModules","resolve","createResolveConfig","undefined","filter","aliases","require","babel","presets","plugins","entry","entries","reduce","key","path","join","paths","src","output","build","devtoolModuleFilenameTemplate","info","relative","absoluteResourcePath","replace","createModuleConfig","createPluginsConfig","createAppBrowserCompiler","compilerOptions","createPobpackCompiler","createAppWebpackConfig","process","NODE_ENV","compilers","map","t","clean","compiler","run","runDevServer","host","port","https","webpackDevServerOptions","browserDevServer","WebpackDevServer","hot","quiet","overlay","compress","clientLogLevel","before","app","server","use","evalSourceMapMiddleware","createLaunchEditorMiddleware","noopServiceWorkerMiddleware","listen","watchAndRunDevServer","runOptions","url","successMessage","webpackDevServer","cmd","argv","Number","PORT","console","log","exit"],"mappings":"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"}