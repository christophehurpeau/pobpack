{"version":3,"file":"index-node8.cjs.js","sources":["../src/createBrowserWebpackConfig.ts","../src/index.ts"],"sourcesContent":["import path from 'path';\nimport {\n  createModuleConfig,\n  createPluginsConfig,\n  createResolveConfig,\n} from 'pobpack-utils';\nimport {\n  Options,\n  ConfigEntry,\n  FilledWebpackConfiguration,\n} from 'pobpack-types';\n\nexport type BrowserTargetType = 'modern' | 'all';\n\nexport const MODERN = 'modern';\nexport const ALL = 'all';\nexport const TARGETS: Array<BrowserTargetType> = [ALL, MODERN];\n\nconst ExcludesFalsy = (Boolean as any) as <T>(\n  x: T | boolean | null | undefined,\n) => x is T;\n\nexport default (target: BrowserTargetType) => (\n  options: Options,\n): FilledWebpackConfiguration => ({\n  // production or development\n  mode: options.env === 'production' ? 'production' : 'development',\n\n  // Don't attempt to continue if there are any errors.\n  bail: options.env === 'production',\n\n  // Target web\n  target: 'web',\n\n  // get right stack traces\n  devtool: options.env === 'production' ? 'nosources-source-map' : 'source-map',\n\n  optimization: {\n    noEmitOnErrors: true,\n    minimize: options.env === 'production',\n    ...options.optimization,\n  },\n\n  // use cache\n  cache: options.hmr,\n\n  devServer: {\n    // don't watch node_modules (improve cpu and memory usage)\n    watchOptions: {\n      ignored: /node_modules/,\n    },\n  },\n\n  // Some libraries import Node modules but don't use them in the browser.\n  // Tell Webpack to provide empty mocks for them so importing them works.\n  // fs and module are used by source-map-support\n  node: {\n    fs: 'empty',\n    module: 'empty',\n  },\n\n  resolveLoader: {\n    modules: options.resolveLoaderModules || ['node_modules'],\n  },\n\n  resolve: createResolveConfig(\n    [target === MODERN ? 'modern-browsers' : undefined, 'browser'].filter(\n      ExcludesFalsy,\n    ),\n    {\n      ...options,\n      babel: {\n        presets: [require.resolve('../babel')],\n        ...options.babel,\n        plugins: [\n          options.hmr && require.resolve('react-hot-loader/babel'),\n          ...(options.babel.plugins || []),\n        ].filter(ExcludesFalsy),\n      },\n    },\n  ),\n\n  entry: options.entries.reduce(\n    (entries: { [key: string]: Array<string> }, entry: ConfigEntry) => {\n      if (typeof entry === 'string') entry = { key: entry, path: entry };\n      entries[entry.key] = [\n        // options.env !== 'production' && require.resolve('../source-map-support'),\n        target !== MODERN && require.resolve('regenerator-runtime/runtime'),\n        options.hmr && require.resolve('react-hot-loader/patch'),\n        options.hmr && require.resolve('react-dev-utils/webpackHotDevClient'),\n        path.join(path.resolve(options.paths.src as string), entry.path),\n      ].filter(ExcludesFalsy);\n      return entries;\n    },\n    {},\n  ),\n\n  output: {\n    path: path.resolve(options.paths.build as string),\n    // devtoolModuleFilenameTemplate: 'file://[absolute-resource-path]',\n  },\n\n  module: createModuleConfig(options),\n\n  plugins: createPluginsConfig(options),\n});\n","import WebpackDevServer, {\n  Configuration as WebpackDevServerConfiguration,\n} from 'webpack-dev-server';\nimport {\n  Options,\n  PobpackCompiler,\n  WatchCallback,\n  CreateCompilerOptions,\n} from 'pobpack-types';\nimport { createPobpackCompiler, createAppWebpackConfig } from 'pobpack-utils';\nimport createBrowserWebpackConfig, {\n  TARGETS,\n  ALL,\n  MODERN,\n  BrowserTargetType,\n} from './createBrowserWebpackConfig';\n\nexport { TARGETS, ALL, MODERN };\n\nexport const createAppBrowserCompiler = (\n  target: BrowserTargetType,\n  options: Partial<Options>,\n  compilerOptions?: CreateCompilerOptions,\n): PobpackCompiler =>\n  createPobpackCompiler(\n    target,\n    createAppWebpackConfig(createBrowserWebpackConfig(target))({\n      entries: [{ key: target, path: 'index' }], // override default entry\n      ...options,\n      paths: { build: 'public', ...options.paths },\n    }),\n    compilerOptions,\n  );\n\nexport const build = (options = {}) => {\n  if (!process.env.NODE_ENV) process.env.NODE_ENV = 'production';\n  const compilers = TARGETS.map((t) =>\n    createAppBrowserCompiler(t, { ...options, hmr: false }),\n  );\n  compilers[0].clean();\n  return compilers.map((compiler) => compiler.run());\n};\n\nexport const watch = (options: Partial<Options>, callback?: WatchCallback) => {\n  if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n  const compiler = createAppBrowserCompiler(MODERN, { ...options, hmr: true });\n  compiler.clean();\n  compiler.watch(callback as WatchCallback);\n  return compiler;\n};\n\ntype Omit<T, K extends keyof T> = Pick<T, Exclude<keyof T, K>>;\n\nexport interface RunOptions\n  extends Omit<WebpackDevServerConfiguration, 'hot' | 'quiet' | 'overlay'> {\n  host?: string;\n  https?: boolean;\n  port: number;\n}\n\nexport const runDevServer = (\n  compiler: PobpackCompiler,\n  options: RunOptions,\n) => {\n  const { host, port, https, ...webpackDevServerOptions } = options;\n  const browserDevServer = new WebpackDevServer(compiler.compiler, {\n    hot: true,\n    // stats: 'errors-only',\n    quiet: true, // errors are displayed with friendly-errors plugin\n    // without page refresh as fallback in case of build failures: hotOnly: true,\n    https,\n    overlay: true,\n    ...webpackDevServerOptions,\n  });\n  browserDevServer.listen(port, host as string); // note: host can be undefined, but types does not support it\n  return browserDevServer;\n};\n\nexport type PobpackBrowserCompiler = PobpackCompiler & {\n  webpackDevServer: WebpackDevServer;\n};\n\nexport const watchAndRunDevServer = (\n  options: Partial<Options>,\n  runOptions: RunOptions,\n): PobpackBrowserCompiler => {\n  const url = `http${runOptions.https ? 's' : ''}://localhost:${\n    runOptions.port\n  }`;\n  const compiler: PobpackCompiler = createAppBrowserCompiler(\n    MODERN,\n    { ...options, hmr: true },\n    {\n      successMessage: `Your application is running here: ${url}`,\n    },\n  );\n  compiler.clean();\n  const webpackDevServer = runDevServer(compiler, runOptions);\n  return { ...compiler, webpackDevServer };\n};\n"],"names":["MODERN","ALL","TARGETS","ExcludesFalsy","Boolean","target","options","mode","env","bail","devtool","optimization","noEmitOnErrors","minimize","cache","hmr","devServer","watchOptions","ignored","node","fs","module","resolveLoader","modules","resolveLoaderModules","resolve","createResolveConfig","undefined","filter","babel","presets","require","plugins","entry","entries","reduce","key","path","join","paths","src","output","build","createModuleConfig","createPluginsConfig","createAppBrowserCompiler","compilerOptions","createPobpackCompiler","createAppWebpackConfig","createBrowserWebpackConfig","process","NODE_ENV","compilers","map","t","clean","compiler","run","watch","callback","runDevServer","host","port","https","webpackDevServerOptions","browserDevServer","WebpackDevServer","hot","quiet","overlay","listen","watchAndRunDevServer","runOptions","url","successMessage","webpackDevServer"],"mappings":"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"}